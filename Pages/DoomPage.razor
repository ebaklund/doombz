@page "/"

@inject IJSRuntime JsRuntime

<canvas
  @ref="@canvasRef"
  width="@innerWidth"
  height="@innerHeight"
  @onmousedown="@OnMouseDown"
  @onmousemove="@OnMouseMove"
  @onmouseup="@OnMouseUp"
  @onmouseout="@OnMouseOut"
  @ontouchstart="@OnTouchStart"
  @ontouchmove="@OnTouchMove"
  @ontouchend="@OnTouchEnd"
  @ontouchcancel="@OnTouchCancel"
/>

@code {
  long innerWidth;
  long innerHeight;

  private ElementReference canvasRef;

  protected override async Task OnInitializedAsync()
  {
    innerWidth = await JsRuntime.InvokeAsync<long>("_WindowInterop.innerWidth");
    innerHeight = await JsRuntime.InvokeAsync<long>("_WindowInterop.innerHeight");
  }

  public async Task DrawLine(long startX, long startY, long endX, long endY)
  {
      await JsRuntime.InvokeAsync<object>("_DoomInterop.drawLine", canvasRef, startX, startY, endX, endY);
  }

  public async Task SetStrokeStyleAsync(string strokeStyle)
  {
      await JsRuntime.InvokeAsync<object>("_DoomInterop.setContextPropertyValue", canvasRef, "strokeStyle", strokeStyle);
  }

  bool isPainting = false;
  double x;
  double y;

  private void OnMouseDown(MouseEventArgs e)
  {
    x = e.ClientX;
    y = e.ClientY;
    isPainting = true;
  }

  private async Task OnMouseMove(MouseEventArgs e)
  {
    if (isPainting)
    {
      double eX = e.ClientX;
      double eY = e.ClientY;

      await DrawLine((long)x, (long)y, (long)eX, (long)eY);
      x = eX;
      y = eY;
    }
  }

  private void OnMouseUp(MouseEventArgs e)
  {
    isPainting = false;
  }

  private void OnMouseOut(MouseEventArgs e)
  {
    isPainting = false;
  }

  private void OnTouchStart(TouchEventArgs e)
  {
    x = e.Touches[0].ClientX;
    y = e.Touches[0].ClientY;
    isPainting = true;
  }

  private async Task OnTouchMove(TouchEventArgs e)
  {
    if (isPainting)
    {
      double eX = e.Touches[0].ClientX;
      double eY = e.Touches[0].ClientY;

      await DrawLine((long)x, (long)y, (long)eX, (long)eY);
      x = eX;
      y = eY;
    }
  }

  private void OnTouchEnd(TouchEventArgs e)
  {
    isPainting = false;
  }

  private void OnTouchCancel(TouchEventArgs e)
  {
    isPainting = false;
  }
}
